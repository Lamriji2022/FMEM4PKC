import time
import random

e=65537 # for all security levels

# RSA1024 (80 security level)
p80=8848587944222328531083032308855816294720468610664598838702705332974037285300246480672785711167321565791768077382735171706419739033232740852638634921307991
q80=4467707603787711255262925145868770746343585779333497738918156891134274929387004231093274761838460634333201736217015849852917856539280691636159916227632071
n80=p80*q80
d80=33872936983187808234616313847389118438443011962864780027850359948250949131508337517552866408335451891809459433805062640246424680206732895739560738574704859466362057689305927539590135374283815960895094662573485512081313991135004358594634046391911036741436576667031911801557070668292347151438551525743692564073

# RSA2048 (112 security level)
p112=141246869063773204193367533583526048566541074914036508160230592001206984558441952807712254466911340603915553248757567335298873912490566084845324656699819748151747619168677293644847618878366103806098605596009519552328516935443018559058218282450019669430862338715723696346444708780159162711428920873445935706681
q112=100803815681377710449770633330797820486733240748467652503352669415302066209147018407210983943315194216922815440946619792678411674016212684530656661793793252618945812497715272503985822617792315662974027484693843045911126017381797999131663846845192169437457687645499503969621381521123723681555572232269554086531
n112=p112*q112
d112=1617461477876084437164879194145237843140856855127879015514153825315840019956369838911310018610182524766947884869806541762915513308807389704249493315089169193053615931647562189741845867385416612502134028152637765571416180346636868669224017196084924329551423891712521314358571163084624648824459037957406860520633778646847730122152103720520311381274992971321467431731616441523265704771031580521743316784558853211022762930279990718570688390288495565930112698143686300294852448319226428871261622922132799809214984603110374202585052158014623000278708692093240256540137368789273146644847694041342117856534167836885157767473

# RSA3072 (128 security level)
p128=2391351713113090344463196915362500708859187101850635959744955044475134344356022077589973378347751016314213129202678641664228921473051296695765663602777210770849642940321574535275680009231857253185379138854572766108580853145986754949274395564758648659313375723962430231075654186416447898096994452039599489812873607228854749585510374930641955955310041956591886078213450350816603155424653650523158020768363944110432696977500906716842614451263407894475040766431359727
q128=1788163747280927711820895571214971095052507669753800302406970020488761647692319105425987704186724278485046488530938198660800310974804601340433569854192688132341419085431986208470544424998652348119739607663729793882888054153911055112866452853730387123425685484904260666806585708774461100894586251039581812672571309973209006660524302343089548886677433057949265552239250448446603417755090199090727487045634787987088022952558054931553413459218825070706791544092598823
n128=p128*q128
d128=1097463728387152740849935621524881867484892902850593098525675412296946517625171721791773475239893715295765169319853833297438391744119659606060848262070332764525197894381550732219655103415772163901720818228597796425955295337034024534358408588170876782706269948915854289071510457492784765264146099656069868860348558604118628575441213106473147433203193144366199305448856694044691620966319807340816044165996250643610422466341056419835082384423923022052323881217593962502288329921438490413936652450350426173669636810262754408129737872584771748074029735883070799387213510128161841304314464888622279431628013329067970131148773027347961364213729995330030318924573263078175849968844190834047243530484997976616220125699333853942052457421877950662331175342879737127358680742790723062191593386426908983684499906079638241602922768868926838822226466992478244050422704087923769246614393319840960231871912942970024368929476749138348330437393

# RSA7680 (192 security level)
p192=6545633418403619886417016649275156241280969082911766925876731623196144762178367589007886639214686552110952211131677090808450274309003503968034181571313234780618535808153835676680377202495144833096437389868621671605460389578828741437257930843154575116655959230798839426011074312335194293893003774597911124365614270282010773217309494401043468532954636092554764622821699643432688113818149805128399194345779315728864012531205591901918805156182825620414627438717030049648608306063378596707804464448792514558605945429676958970787495484710861095936091745766222930807797458445472530074790899574041891536727004217678427589203576493632827185752294831820743456557366774095875297584816160922171925240703358253361255755272543834258292348845575606727541844158983472882535216004620303679906396624115712743927474899011594724620495523773376202587011890702588874242211649173936054076842493872944264756085085748503208926523118503552211300208970354869652219014872031247812059422204132423556397905540886833150022842789207819965343554175750830241353511794628761414924488786438853498663705770412828740474664189358317421082616198373510346158431426338133660794845401675253641116723
q192=3790699701875588454070464939699510218942317583572083512220415464472482944812231435629061276918708629996287474817419479963618701025915679792047114446604314554518423201757672531035853818066096119652187305457795146730164795136863938511188440052017805497032378224783609856364482993800235841039809276052015990246538946822863841057067629827757294132025680498625341089800051302100432616448021577700689857060986157690821270311167587581449556108246522734504134003369170969895781396657791562887766943612388036197499245109930718189161492376963696117258190722863183054900358851594946171093463317903288046078594768703375130115447615427179955598778141494157827717879163770144982488841459504478725854461085882752253033277694552822295625662037046723158437424464293869365946434088814944891655209485967074502156527632215002953445029871283163615617317826578268386429202402898622972522667194619748150793871081686589278130350037860874007188784029673104494857169288090519676669016055279719158785157410859923392997575121880450138732337329729913922812223716096883264906151892167302414728005152515451518581883132733239088469706975961087620185035652037093158500249341663575195443837
n192=p192*q192
d192=13270048967803205123357749639789624408436261883973696878118747326479648875956239157170587403572403120863178027581540167915030229370990240324824527110781107508983243415662339024418665160437906515687656996135596304853267062438359992969275063534166357100133316028831923603947560357650030924294842324975657700163195677911654876403873695711944603219962768976639273159754889730098630162909198276489183875950352006558816712308285465227737027218002337574357643230443457492230565812816807056654564625040119417686508080988896852838475866211837655401436649189415020186790095636581785413304651282013311436923208131254486107813891315485506516622594995886007483525653484054186276919215855969740134140299914970684492414617128797395905253401970880637514048716224531606588924775151493312159263969983075518677920210188771805108632387841468984624259641345425664131779761596302021387514010305420174831057245536431936121233050105944210727248904593874376368537909166621381645377703095295697435775473204904693775296126794460819293232250969039786684473072009714827053256188179555167922572905969935460339816593451542312200979245774320902085267712037158246269503161505660148458008153072308466544869791685966737928879314977836948387171248054598942334421791914895240087938376038486160810900195771028523997354668380756901360171075757005280000404273595600944436623221145280533559643834824764677052577832078412479414977519986024093742597157319022080263431916569806821335119696848170371447146907020538331270085203595860484409064325226734108827926241881774734736395653775136210727881287510488691908435085215460393078094793435973935912803216864847146053429436066441594672454846672058951473162651231986660476054552009615151193901396666090760364982182930316727198245400730031066256490714773475353820948740176832026404532669612280140310795735885521770461793960585397097066672353153244091379267605812050481145890744401925497866434575714577325165909688258485119833014297729342852874898664157811374719571805575589542199645928569261094240470584555675020921435788390521417491347919963718959322507225743247306177704847453981771354562838881270139055792912584214451620188919505071860558257250038059995087544528510213503124738810893754654178313060600201805700146142878638600928447484649730812759099782935393984428549624751917282369868038168894452349512084273

# RSA15360 (256 security level)
p256=52597861102220385900176133033557030862408132024699565923759735705297287387396007083585168497096402252881198065843880806614667181931601679106098584717894915434993900608494359636486710619002373329974590392434135995888774248397850587668713220853182815452950863957405658639470473971204596909401826771095022450000148323698734030277845172436547557173107814785508328507451539692077148809288597401019636881421359971590040855593353588756707300059102737039761942119215284794165494075678590906897443619549974920047503837759369941148550645844809009140587574841005302056127808975594953029010914567303059317096529601850056406502293790623130989751358436080894122654695925337946113585828170002034619417858565852766949201762092649860622853388030236461039182966898491933923177557587137023614409779322938692239392223505671024563252391845032589151997541475898813290998646771267781599176509301826646547965840575532799947277885446330976064301349989443095202693396857586847695373110044591154481126062015295262278177471197029179663213914612154126427894720570528151258224397537095545782633573050786856364210188554867168914736191499236419029902839795789404664999642770922910490224215366086551815377256942552710010067476100224247773655191253598978770889194368190175518959525639000664524840136439842179610725866224656456955696011298212614862344512442599612773832509600157398547002433686302645287287610204514350450110568179736208486886249389121999871086706078341186505453959325369072341799203297527839281387482620989202522959107652527348021296608766303334017506765138919025830550215620222685413625216218252413057492567850028675418117922639786920481972319504086463306645750445565568781721035764506981706854327949021268577350340454108297068997709952435223008944634226207280819146928147256035330496576694500163213585496279273712854084134469021733612675284232296909821189261318920366269375465201369767421754377263800106013201827651214482092700712893358288223729680844093441302452305303173024119155854519778421625184253998106115415900910068482592346308394664757597510019906811228971147418824590996410390380040826221457345404771091382357739980078963285338037016312634107186467249228043182765753857103499382986799621957157548064459480164846184278485459964454403746597501698713140484883553875867077390732429308032174908869791714748045331340925972671
q256=77596872013406337337434114753007120709249731542348812419112391686200606320045678826828286187004247052882927054034059341184140136998597393041543448134090773232989332755570980394069742842029015069352055176247262747994557383806122776636117514230596039137809433986924327664614616896720824127141818231129316875132169128928097967832034906282056944725886314857610767562333987097274716510534817093062339887733264946417150823034569708879482009024422897742608354633597425355103008774415785750623911144595785084791480728013382188895131831210913779197932565005442590478388808322182523376204746990580543748924742107574833883023280523023032811248515548828994727958265523270812037350353357797556381540646948880666131321840342960447194711052807875723735870133446128722271094237605748405156566428733752378762151773759078401343901780048322684273805483164942066893189575069850594184369459756550532919659617177060910324385444027685614207412245440375920585950755692213523419378118970796326195941014576005139713286969500013019667793705761017038002001508726229355984993542906685397084508945573936081749829004337400070891331514606764125927936452239729731400181336709991120689794372869003189693703777359092230849146810327894682600196718849000635247915883432139176200961930179850138599971831878821406174502671013238587604768617282778664862770887785368610731804204326084418448237549180733710512950307833418389117501394455712203926878242402192730680645914353751796553188050370095893748075173847444966834291425896741314839662483878723124976206047058127676899572795357461825326196454642092018330889504787738516842224073863512338557896222887495164368846990068468789003978020482226698319944805498221600842802982032485627962723628610145423640583707181178135613234046255540745191042765955908638829568985954545323837156590231571751622053490427356513107695550433414921166140068668534429172047385090537356623828787569262483325721443731508675583894460650634230457944059287821167020758858011305389413508183233674253721547358344053066699049764645287040297675704029162534470687567196971586999347054287282451768910360806489813867497329947368677409747531152422828394884763363353378467065782379404513695928829853215468772485789153553199948284899029991985220971848279264058047143166205724989041835490691192275130930713850517933960358210709115127081223418831
n256=p256*q256
d256=2607837712290104866969990887528072480652665556444125223059562904900122887938459677980252525683274350910659118534802752985008274535936067723364216303002087510930762547886771848272567055755202820874803061894733186804660984129289350300377943420008420741586614913530427780948480746624022423053739217908668784535215847241815730608681755958284677920977355086423796108718004053033975443333298934901119534704712302327521466158931819000429511313773642523253919343073746579872204269589560867515465052594481957036792733995169769971002850020449356638038077849486023328953651335332784802193520602973355440462131641583162180499750161963499956065360825130405011786353666640936641212957086486239557094289770605266790441176205335295609847218995740099230352721360289538508252013455512063304353106215539156132279148632455711874584935582384304989646714381378300577856433045295391064103509873909863722947316456366295615756577919063254785884360989532869647910971955001880048972722468921447701695230425688214854803958274768673171410198234858971814451152027555508498032644473602121896278226199382323804223477134854059101849170809392759179619535506547103663791808582473385100770840847796994377307252452052689497349768295025232443619581453451132412641282447200808831484899019010142116410756950221032459167482293832294000031391561137699128108064364214454822857937635572327217896996238604294629667128592165856262260317114104985391167833279917947080734234281190257055540240266691627359708257821030049341325943340020295354007904011376962098344528859611733900701611391860614559996281988769965881727013430650818352059084282788636896017892077916922597777458289897261283513803396918938032546895041156522125517210076460954797782996662399605983129338013328568478177202917232851061848376507450688766173982832757237855802629987804415877684695244923746729774851500411741654723728261874885983284129856468059392766107630095981414625128637498300851680069064677112092428889145756195882206615659357919537103966302046211809371618801368060318244834298164587690500205852856853616639705558795806203693733376382811187214131365117873261943608763366577970132593443356409811754057165977981761851793947547945003153324817228446877487813125297625511299643922261891842937890117830571825328333032774232110026024366152005754944448667058660832493392211749692700239735918411838723381962449657698470403051552323033599980986468029590072987240981038720481840000777324510986250292042861383634087755251871069757310846982466184228057041567438232858736387067306862474446907620337237228795642086334411665887653598565979266233893195980795164229895017845141456207977580202013264316401518457394452903800494323932237765256890552326897039946799329123314985967639177859427963077154884027202687422009552634735294804390430813520306447269829993570804235320263895925778362215329778209011232770879794210014930301352566909914548729592559189224294070429525207257702352730000484926951123191821371244384887384038402541263434147088920016867246360676492121572993860613411178070911440057844388335551472726174193136719131147664565324089100395019453737578773038667920001113665399535677341809318902114065114391323356029850409107074369972095654202092289082761126336826796309031850440095583434107959384888771995358104531580386987325447632023561702563624479727768988857526933268258581734987196249528406854107802056212364542670633240289747993496040859154394361673278100036637615235771159100428715447026737388399020925074780074047447890997036727817782402342442978446914884045954880181838431434331830587146062805267399411059503604548393608593260233386761287106619425733134315134466425902860683547921503399038817770593956041269543548096783365000148798366132402383704798237065228609601593022944954559599720769832561400461623388433333750278054466094865459452559265054529958621715164760546096360339850657032866077026665105579271790585867051891899717598194745539733101926357363943991811190101794749854793595191296108664612651958849813040058487488119701426278684745102616372110928277116912713171836636273086207879565155402816370781018914622899593039132034771894323446901985899862486720546480586768880587910053701105885974980479463460582427454319495765984085310943503778884270882627421295057209670509651733008462446795637529273217386693987737530821828473926298179859730564330676497107411247242235168671211539150624023154912696680066474369756219110129934865424210391644087219874569463995612328537889564994144367178690252261784643200613594939856211147384388098490931663313163744854389914891904705763754411962051690656830003757146399481015559377116641765072141498695730001781693020251828643426301386817597603077786570080988660973

## MMI-Euclid method

def inverse_mod_Euclid(k, p):
    if k == 0:
        raise ZeroDivisionError('division par zero')

    if k < 0:
        return p - inverse_mod_Euclid(-k, p)

    # Algorithme euclidien étendu.
    s, old_s = 0, 1
    t, old_t = 1, 0
    r, old_r = p, k

    while r != 0:
        quotient = old_r // r
        old_r, r = r, old_r - quotient * r
        old_s, s = s, old_s - quotient * s
        old_t, t = t, old_t - quotient * t

    gcd, x, y = old_r, old_s, old_t

    assert gcd == 1
    assert (k * x) % p == 1

    return x % p

######################################################## ME-Methods ####################################################

################################################## Left-to-Right Binary Method

## Calculate ME with LR Binary method
def LR_BinaryM(x,k,p):
    k = list(bin(k)[2:])
    x1 = 1
    for i in range(len(k)-1 ,-1,-1):
        x1  = x1**2 % p
        if int(k[i]) == 1:
            x1 = x1 * x % p
    return x1

################################################## Window Method

## List of the digits in the base 'b' representation of n 
def Win_Rep(k, base):
    digits = []
    while k:
        digits.append(k % base)
        k //= base
    return digits

## Calculate ME with Window method
def ME_Window(x,k,w,p):
    base = 2 << (w - 1)

    # Precompute the table of exponents

    table = [1] * base
    for i in range(1, base):
        table[i] = table[i - 1] * x % p
    r = 1
    for digit in reversed(Win_Rep(k, base)):
        for i in range(w):
            r = r * r % p
        if digit:
            r = r * table[digit] % p

    return r




################################################## NAF Method

## NAF reoresentation of k
def naf(k):
    Naf = []
    i=0
    while k>0:
        if k%2 == 1:
            Naf.append(2 - k%4)
            k = k - Naf[i]
        else:
            Naf.append(0)
        k = k//2
        i = i+1
    return Naf

# Calculate ME with WNAF method
def ME_NAF(m,k, p):
    Naf=naf(k)
        
    x = m
    y = inverse_mod_Euclid(m, p)
    for j in range(len(Naf)-2,-1,-1):
        x = x*x % p
        if Naf[j] == 1:
            x = x*m % p
        if Naf[j] == -1:
            x = x*y % p
            
    return x

############################################# WNAF method

def mods(d,w):
    t=pow(2,w)
    if (d % t) >= t - 1:
        return (d % t) - t
    else:
        return d % t

# WNAF representation of k    

def w_naf(k,w):
    wNaf=[]
    wNafT=[]
    i=0
    while k>0:
        if k%2 == 1:
            wNaf.append(mods(k,w))
            k = k - wNaf[i]
        else:
            wNaf.append(0)
        k = k//2
        i = i+1
    for i in wNaf:
        wNafT.append(abs(i))
        
    wNafT = set(wNafT)
    return (wNaf,list(set(wNafT)))

# Calculate ME with WNAF method
def ME_WNAF(x,k,w,p):
        wNaf = w_naf(k,w)[0]
        wNafT = w_naf(k,w)[1]
        R={}
        R1={}
        for l in wNafT:
            b = (x**l) % p
            R[l] = b
            R1[l] = inverse_mod_Euclid(b,p)
        exp = 1
        for j in range(len(wNaf)-1,-1,-1):
            exp = (exp*exp) % p
            if wNaf[j] > 0:
                exp = (exp*R[wNaf[j]]) % p
            if wNaf[j] < 0:
                exp = (exp * R1[-wNaf[j]]) % p
            
        return exp

############################################# ZR method

## Alternate-Zeckendorf Representation of an integer k
def ZechendorfRep(k):
    F = [1,2,3]
    ZR =[]
    l = len(bin(k)[2:]) +1
    for i in range(3,l):
        F.append(F[i-1]+2*F[i-2])
    for j in range(l-1,-1,-1):
        if (k - F[j] >= 0):
            ZR.append(1)
            k = k - F[j]
        else:
            ZR.append(0)
    return ZR[::-1],l

## Calculate ME with Zechendorf method
def ME_ZR(x,k,n):
    ZR,l = ZechendorfRep(k)
    U = x
    V = x**2 % n
    W = U*V %n
    temp = 1
    z = U**ZR[0] * V**(ZR[1]) * W**(ZR[2]) %n
    for i in range(3,l):
        temp = V
        V = W
        W = temp**2 * W %n
        if ZR[i] == 1:
            z = z*W % n
    return z


############################################Test

levelS = input("Enter security level : 80, 112, 128, 192 or 256 ")

#the values of the parameters according to the security level
if int(levelS) == 80:
    n=n80
    d=d80
    m=random.randint(n-e, n)
    c=pow(m,e,n)
if int(levelS) == 112:
    n=n112
    d=d112
    m=random.randint(n-e, n)
    c=pow(m,e,n)
if int(levelS) == 128:
    n=n128
    d=d128
    m=random.randint(n-e, n)
    c=pow(m,e,n)
if int(levelS) == 192:
    n=n192
    d=d192
    m=random.randint(n-e, n)
    c=pow(m,e,n)
if int(levelS) == 256:
    n=n256
    d=d256
    m=random.randint(n-e, n)
    c=pow(m,e,n)

###### Choose ME method
Meth = input("Enter the name of the method used to calculate ME (choose a name among the following names: LRBM, WM, NAFM, WNAFM, AZRM ) :  ")

#######Decryption
iter = 10
if Meth == "LRBM":
    t1 = time.time()
    for l in range(iter):
        b = LR_BinaryM(c,d,n)
    t2 = time.time()

if Meth == "WM":
    t1 = time.time()
    for l in range(iter):
        b = ME_Window(c,d,5,n)
    t2 = time.time()
if Meth == "NAFM":
    t1 = time.time()
    for l in range(iter):
        b = ME_NAF(c,d,n)
    t2 = time.time()
if Meth == "WNAFM":
    t1 = time.time()
    for l in range(iter):
        b = ME_WNAF(c,d,4,n)
    t2 = time.time()
if Meth == "AZRM":
    t1 = time.time()
    for l in range(iter):
        b = ME_ZR(c,d,n)
    t2 = time.time()
print("Execution time of ",Meth," method in ",levelS," security level is :",(t2 - t1)/iter)
